<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe AI (Universal)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #2c3e50; color: white; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .board { display: grid; grid-template-columns: repeat(3, 100px); gap: 10px; margin: 20px; }
        .cell { width: 100px; height: 100px; background: #ecf0f1; border: none; border-radius: 10px; font-size: 3em; font-weight: bold; cursor: pointer; color: #2c3e50; }
        .cell.x { color: #e74c3c; } 
        .cell.o { color: #3498db; }
        #status { font-size: 1.5em; margin-bottom: 20px; height: 30px; font-weight: bold; }
        button.reset { padding: 12px 24px; font-size: 1.2em; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #debug { margin-top: 20px; background: #34495e; padding: 15px; width: 90%; max-width: 600px; font-family: monospace; font-size: 0.85em; height: 200px; overflow-y: scroll; border: 1px solid #7f8c8d; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>Tic-Tac-Toe</h1>
    <div id="status">Loading Brain...</div>
    
    <div class="board">
        <button class="cell" onclick="handleMove(0)"></button>
        <button class="cell" onclick="handleMove(1)"></button>
        <button class="cell" onclick="handleMove(2)"></button>
        <button class="cell" onclick="handleMove(3)"></button>
        <button class="cell" onclick="handleMove(4)"></button>
        <button class="cell" onclick="handleMove(5)"></button>
        <button class="cell" onclick="handleMove(6)"></button>
        <button class="cell" onclick="handleMove(7)"></button>
        <button class="cell" onclick="handleMove(8)"></button>
    </div>

    <button class="reset" onclick="resetGame()">New Game</button>
    <div id="debug">Initializing...</div>

    <script>
        let Q_Normalized = {}; 
        let board = [0, 0, 0, 0, 0, 0, 0, 0, 0];
        let currentPlayer = 1; 
        let gameOver = false;

        function log(msg) {
            const d = document.getElementById('debug');
            d.innerHTML = `> ${msg}<br>` + d.innerHTML;
        }

        // --- 1. UNIVERSAL LOADER ---
        fetch('q.json')
            .then(res => res.json())
            .then(data => {
                let count = 0;
                for (let key in data) {
                    let cleanKey = key.replace(/[\[\]\(\)\s]/g, '');
                    Q_Normalized[cleanKey] = data[key];
                    count++;
                }
                log(`BRAIN LOADED: ${count} states normalized.`);
                
                // FIX 1: Don't hardcode text here. Call resetGame to trigger the coin flip immediately.
                resetGame();
            })
            .catch(err => {
                document.getElementById('status').innerText = "Error loading q.json";
                log("ERROR: q.json not found.");
            });

        function handleMove(index) {
            if (board[index] !== 0 || gameOver || currentPlayer !== 1) return;

            currentPlayer = -1
            
            makeMove(index, 1);
            
            // Only let AI think if the game is NOT over
            if (!gameOver) {
                document.getElementById('status').innerText = "AI Thinking...";
                setTimeout(aiMove, 200);
            }
        }

        function aiMove() {
            if (gameOver) return;

            // Flip Board Logic
            let canonicalBoard = board.map(c => c === -1 ? 1 : (c === 1 ? -1 : 0));
            let stateStr = canonicalBoard.join(',');

            let legalMoves = [];
            board.forEach((c, i) => { if (c === 0) legalMoves.push(i); });
            legalMoves.sort(() => Math.random() - 0.5); 

            let bestMove = legalMoves[0];
            let bestValue = -Infinity;

            log(`Checking State: ${stateStr}`);

            for (let move of legalMoves) {
                let key = `${stateStr}_${move}`;
                let val = Q_Normalized[key];
                if (val === undefined) val = 0.0;
                
                // log(`.. Move ${move}: ${val}`); // Uncomment for full spam

                if (val > bestValue) {
                    bestValue = val;
                    bestMove = move;
                }
            }

            log(`>> AI PLAYS: ${bestMove} (Value: ${bestValue})`);
            makeMove(bestMove, -1);

            if (!gameOver) {
                currentPlayer = 1;
                document.getElementById('status').innerText = "Your Turn (X)";
            }
        }

        function makeMove(index, player) {
            board[index] = player;
            let btn = document.querySelectorAll('.cell')[index];
            btn.innerText = player === 1 ? "X" : "O";
            btn.className = `cell ${player === 1 ? 'x' : 'o'}`;
            
            let win = checkWin();
            
            // FIX 2: Check for null explicitly. 
            // Because '0' (Draw) evaluates to False in JS if you just do "if (win)"
            if (win !== null) {
                gameOver = true;
                let msg = "";
                if (win === 1) msg = "YOU WIN!";
                else if (win === -1) msg = "AI WINS!";
                else msg = "DRAW!"; // win is 0
                
                document.getElementById('status').innerText = msg;
                log(`GAME OVER: ${msg}`);
            }
        }

        function checkWin() {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (let w of wins) {
                let s = board[w[0]] + board[w[1]] + board[w[2]];
                if (s === 3) return 1;
                if (s === -3) return -1;
            }
            if (!board.includes(0)) return 0; // 0 for Draw
            return null; // Game continues
        }

        function resetGame() {
            board.fill(0);
            gameOver = false;
            
            document.querySelectorAll('.cell').forEach(c => { 
                c.innerText = ""; 
                c.className = "cell"; 
            });

            // 50/50 Coin Flip
            currentPlayer = Math.random() < 0.5 ? 1 : -1;

            if (currentPlayer === 1) {
                document.getElementById('status').innerText = "You are X. Start!";
                log("--- NEW GAME (You Start) ---");
            } else {
                document.getElementById('status').innerText = "AI Starts... (O)";
                log("--- NEW GAME (AI Starts) ---");
                setTimeout(aiMove, 500);
            }
        }
    </script>
</body>
</html>

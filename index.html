<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe AI (Unbeatable)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #2c3e50; color: white; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        h1 { margin-bottom: 10px; }
        .board { display: grid; grid-template-columns: repeat(3, 100px); gap: 10px; margin: 20px; }
        .cell { width: 100px; height: 100px; background: #ecf0f1; border: none; border-radius: 10px; font-size: 3em; font-weight: bold; cursor: pointer; color: #2c3e50; }
        .cell.x { color: #e74c3c; } /* Red for X */
        .cell.o { color: #3498db; } /* Blue for AI (O) */
        .status { font-size: 1.5em; margin-bottom: 20px; height: 30px; }
        button.reset { padding: 10px 20px; font-size: 1.2em; background: #e67e22; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #debug { margin-top: 20px; background: #34495e; padding: 10px; width: 90%; max-width: 600px; font-family: monospace; font-size: 0.9em; height: 150px; overflow-y: scroll; border: 1px solid #7f8c8d; }
    </style>
</head>
<body>

    <h1>Tic-Tac-Toe AI</h1>
    <div id="status" class="status">Loading Brain...</div>
    
    <div class="board">
        <button class="cell" onclick="handleMove(0)"></button>
        <button class="cell" onclick="handleMove(1)"></button>
        <button class="cell" onclick="handleMove(2)"></button>
        <button class="cell" onclick="handleMove(3)"></button>
        <button class="cell" onclick="handleMove(4)"></button>
        <button class="cell" onclick="handleMove(5)"></button>
        <button class="cell" onclick="handleMove(6)"></button>
        <button class="cell" onclick="handleMove(7)"></button>
        <button class="cell" onclick="handleMove(8)"></button>
    </div>

    <button class="reset" onclick="resetGame()">New Game</button>
    
    <div id="debug">Log initialized...</div>

    <script>
        let Q = {};
        let board = [0, 0, 0, 0, 0, 0, 0, 0, 0];
        let currentPlayer = 1; // 1 = Human, -1 = AI
        let gameOver = false;

        function log(msg) {
            const d = document.getElementById('debug');
            d.innerHTML = `> ${msg}<br>` + d.innerHTML;
        }

        // Load the Brain
        fetch('q.json')
            .then(res => res.json())
            .then(data => {
                Q = data;
                document.getElementById('status').innerText = "You are X. Start!";
                log(`BRAIN LOADED: ${Object.keys(Q).length} states.`);
                
                // CHECK FORMAT: Does the JSON use spaces?
                const sampleKey = Object.keys(Q)[0];
                log(`Sample Key from JSON: "${sampleKey}"`);
                if (sampleKey.includes("1, 0")) {
                    log("WARNING: JSON has spaces. Adjusting logic...");
                } else {
                    log("SUCCESS: JSON is compact (no spaces).");
                }
            })
            .catch(err => {
                document.getElementById('status').innerText = "Error loading q.json";
                log("ERROR: Could not find q.json. Make sure it is in the same folder.");
            });

        function handleMove(index) {
            if (board[index] !== 0 || gameOver || currentPlayer !== 1) return;
            
            makeMove(index, 1); // Human Move
            
            if (!gameOver) {
                currentPlayer = -1;
                document.getElementById('status').innerText = "AI Thinking...";
                setTimeout(aiMove, 300);
            }
        }

        function aiMove() {
            if (gameOver) return;

            // 1. FLIP BOARD (Relativity)
            // AI is -1. We must convert -1 to 1 so it matches the training data.
            let canonicalBoard = board.map(cell => {
                if (cell === -1) return 1; // AI becomes 1
                if (cell === 1) return -1; // Human becomes -1
                return 0;
            });

            // 2. GENERATE KEY (Standardize Format)
            // JSON.stringify produces "[1,0,-1]" (Compact, No Spaces)
            let stateStr = JSON.stringify(canonicalBoard);

            // 3. FIND BEST MOVE
            let legalMoves = [];
            board.forEach((c, i) => { if (c === 0) legalMoves.push(i); });
            
            // Randomize to break ties
            legalMoves.sort(() => Math.random() - 0.5);

            let bestMove = legalMoves[0];
            let bestValue = -Infinity;

            log(`AI looking at state: ${stateStr}`);

            for (let move of legalMoves) {
                // Key format: "[1,0,-1]_4"
                let key = `${stateStr}_${move}`;
                let val = Q[key];

                if (val === undefined) {
                    // Fallback: Try WITH spaces just in case JSON is old
                    let spacedKey = `${stateStr.split(',').join(', ')}_${move}`;
                    val = Q[spacedKey] !== undefined ? Q[spacedKey] : 0.0;
                }

                log(`.. Move ${move}: Val=${val}`);

                if (val > bestValue) {
                    bestValue = val;
                    bestMove = move;
                }
            }

            log(`>> AI CHOSE: ${bestMove} (Value: ${bestValue})`);
            makeMove(bestMove, -1);

            if (!gameOver) {
                currentPlayer = 1;
                document.getElementById('status').innerText = "Your Turn (X)";
            }
        }

        function makeMove(index, player) {
            board[index] = player;
            let btn = document.querySelectorAll('.cell')[index];
            btn.innerText = player === 1 ? "X" : "O";
            btn.classList.add(player === 1 ? "x" : "o");

            let win = checkWin();
            if (win) {
                gameOver = true;
                let msg = win === 1 ? "YOU WIN!" : "AI WINS!";
                if (win === "draw") msg = "DRAW!";
                document.getElementById('status').innerText = msg;
                log(`GAME OVER: ${msg}`);
            }
        }

        function checkWin() {
            const wins = [
                [0,1,2], [3,4,5], [6,7,8], 
                [0,3,6], [1,4,7], [2,5,8], 
                [0,4,8], [2,4,6]
            ];
            for (let w of wins) {
                let s = board[w[0]] + board[w[1]] + board[w[2]];
                if (s === 3) return 1;
                if (s === -3) return -1;
            }
            if (!board.includes(0)) return "draw";
            return null;
        }

        function resetGame() {
            board = [0,0,0,0,0,0,0,0,0];
            gameOver = false;
            currentPlayer = 1;
            document.querySelectorAll('.cell').forEach(c => {
                c.innerText = "";
                c.className = "cell";
            });
            document.getElementById('status').innerText = "You are X. Start!";
            log("--- NEW GAME ---");
        }
    </script>
</body>
</html>
